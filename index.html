<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LinkedIn CAPI (GTM Server-Side) Lead Demo</title>

  <!-- =========================
       Google Tag Manager (GTM)
       Replace GTM-XXXXXXX with your Web GTM Container ID.
       ========================= -->
  <script>
    // GTM_CONTAINER_ID is for human readability only.
    // The GTM snippet below still contains the placeholder string you must replace.
    const GTM_CONTAINER_ID = "GTM-KPR5LSH6";
  </script>
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != "dataLayer" ? "&l=" + l : "";
      j.async = true;
      j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, "script", "dataLayer", "GTM-KPR5LSH6");
  </script>

  <style>
    :root {
      --bg: #f6f7fb;
      --surface: #ffffff;
      --surface-2: #fbfbfe;
      --text: #0f172a;
      --muted: #475569;
      --muted-2: #64748b;
      --border: rgba(15, 23, 42, 0.10);
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      --shadow-2: 0 6px 18px rgba(15, 23, 42, 0.08);
      --accent: #0a66c2;      /* LinkedIn-ish blue */
      --accent-2: #2f7dd1;
      --danger: #b42318;
      --ok: #027a48;
      --ring: rgba(10, 102, 194, 0.22);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 15% 0%, rgba(10, 102, 194, 0.10), transparent 55%),
        radial-gradient(1100px 750px at 90% 10%, rgba(2, 122, 72, 0.08), transparent 55%),
        var(--bg);
      line-height: 1.45;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 56px;
    }

    header {
      display: grid;
      gap: 10px;
      margin-bottom: 18px;
    }

    .topRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.6);
      padding: 6px 10px;
      border-radius: 999px;
      width: fit-content;
      color: var(--muted);
      font-size: 13px;
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(6px);
    }

    .badgeDot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(10, 102, 194, 0.15);
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.02em;
    }

    .sub {
      margin: 0;
      color: var(--muted);
      max-width: 78ch;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 16px;
      margin-top: 18px;
      align-items: start;
    }

    @media (max-width: 920px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: rgba(255, 255, 255, 0.75);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }

    .cardHeader {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .card h2 {
      margin: 0;
      font-size: 18px;
    }

    ul {
      margin: 8px 0 0 18px;
      color: var(--muted);
    }

    .note {
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 14px 0;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 520px) {
      .row { grid-template-columns: 1fr; }
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted-2);
      margin-bottom: 6px;
    }

    input,
    select,
    button,
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      color: var(--text);
      padding: 10px 12px;
      outline: none;
      font-size: 14px;
      transition: box-shadow 140ms ease, border-color 140ms ease, transform 80ms ease;
    }

    input::placeholder { color: rgba(15, 23, 42, 0.35); }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(10, 102, 194, 0.55);
      box-shadow: 0 0 0 4px var(--ring);
    }

    .field { margin-bottom: 12px; }

    .error {
      margin-top: 6px;
      font-size: 12px;
      color: var(--danger);
      min-height: 16px;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    button {
      cursor: pointer;
      font-weight: 650;
      border: 1px solid rgba(10, 102, 194, 0.40);
      background: linear-gradient(180deg, rgba(10, 102, 194, 0.12), rgba(10, 102, 194, 0.06));
      color: var(--text);
    }

    button:hover { border-color: rgba(10, 102, 194, 0.60); }
    button:active { transform: translateY(1px); }

    button.primary {
      background: linear-gradient(180deg, rgba(10, 102, 194, 0.22), rgba(10, 102, 194, 0.10));
    }

    button.secondary {
      border-color: var(--border);
      background: rgba(255, 255, 255, 0.75);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.75);
      color: var(--muted);
      font-size: 13px;
      box-shadow: var(--shadow-2);
      backdrop-filter: blur(6px);
    }

    .ok { color: var(--ok); }
    .muted { color: var(--muted); }

    .success {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(2, 122, 72, 0.25);
      background: rgba(2, 122, 72, 0.06);
      color: var(--text);
      display: none;
    }

    .debug {
      display: grid;
      gap: 10px;
    }

    pre {
      margin: 0;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.8);
      overflow: auto;
      max-height: 360px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
    }

    .tiny {
      font-size: 12px;
      color: var(--muted-2);
    }

    a { color: var(--accent); }
    a:hover { opacity: 0.9; }
  </style>

  <script>
    /**
     * =========================
     * li_fat_id capture (URL or cookie)
     * - Priority: URL param > cookie
     * - If found in URL, persist to cookie
     * =========================
     */
    function getCookie(name) {
      try {
        const parts = ("; " + document.cookie).split("; " + name + "=");
        if (parts.length === 2) return parts.pop().split(";").shift() || "";
        return "";
      } catch (e) {
        return "";
      }
    }

    function setCookie(name, value, days) {
      try {
        if (!value) return;
        const maxAge = (days || 90) * 24 * 60 * 60;
        // Demo-friendly defaults:
        // - path=/ so it works site-wide
        // - SameSite=Lax so it survives standard navigations
        // - Secure only when on https:
        const secure = window.location.protocol === "https:" ? "; Secure" : "";
        document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax${secure}`;
      } catch (e) {
        // no-op
      }
    }

    function getLiFatIdFromUrl() {
      try {
        return (new URLSearchParams(window.location.search)).get("li_fat_id") || "";
      } catch (e) {
        return "";
      }
    }

    function resolveLiFatId() {
      const fromUrl = getLiFatIdFromUrl();
      if (fromUrl) {
        setCookie("li_fat_id", fromUrl, 90);
        return fromUrl;
      }
      const fromCookie = getCookie("li_fat_id");
      return fromCookie || "";
    }

    // Resolved once for the page (used for page_view + lead_submission)
    window.__LI_FAT_ID__ = resolveLiFatId();
  </script>

  <script>
    /**
     * =========================
     * dataLayer Initialization + Debug Panel Interceptor
     * =========================
     */
    window.dataLayer = window.dataLayer || [];

    (function patchDataLayerPush() {
      const dl = window.dataLayer;

      // Keep a reference to original push
      const originalPush = dl.push.bind(dl);

      // Simple helper to read last pushed object (for debug UI)
      function safeRenderDebugPanel() {
        try {
          if (typeof window.renderDebugPanel === "function") {
            window.renderDebugPanel();
          }
        } catch (e) { /* no-op */ }
      }

      // Patch push to intercept events and update debug panel
      dl.push = function () {
        const result = originalPush(...arguments);

        // Detect GTM lifecycle events for page_view sequencing
        try {
          const lastArg = arguments && arguments.length ? arguments[arguments.length - 1] : null;
          if (lastArg && typeof lastArg === "object" && lastArg.event === "gtm.load") {
            window.__GTM_LOAD_SEEN__ = true;
            if (typeof window.__firePageViewWhenReady === "function") {
              window.__firePageViewWhenReady();
            }
          }
        } catch (e) { /* no-op */ }

        safeRenderDebugPanel();
        return result;
      };

      window.__originalDataLayerPush = originalPush;
    })();
  </script>

  <script>
  /**
   * =========================
   * Ensure GTM default events fire BEFORE page_view
   *
   * Primary: wait for GTM to push gtm.load, then push page_view.
   * Fallback: if gtm.load never arrives (adblock, snippet removed, etc),
   *           push page_view after the browser window 'load' event.
   * =========================
   */
  (function initSequencedPageView() {
    let fired = false;

    function buildPageViewPayload() {
      return {
        event: "page_view",
        page_location: window.location.href,
        page_path: window.location.pathname,
        page_title: document.title,
        user_data: {
          user_id: window.__LI_FAT_ID__ || ""
        }
      };
    }

    function fire() {
      if (fired) return;
      fired = true;

      window.dataLayer.push(buildPageViewPayload());

      // Update captured ID UI if present
      try {
        const liFatIdDisplay = document.getElementById("liFatIdDisplay");
        if (liFatIdDisplay) liFatIdDisplay.textContent = (window.__LI_FAT_ID__ || "(none)");
      } catch (e) { /* no-op */ }
    }

    // Expose for the patched dataLayer.push to call when gtm.load is seen
    window.__firePageViewWhenReady = function () {
      if (window.__GTM_LOAD_SEEN__) fire();
    };

    // Fallback: wait for browser window load, then give GTM a beat to push gtm.load
    window.addEventListener("load", function () {
      // Let GTM's own gtm.load push happen first on the same load event
      window.setTimeout(function () {
        if (!fired) {
          // If GTM worked, gtm.load should have been seen already and fired would be true.
          // If GTM didn't work (blocked), we still fire after window load so the demo runs.
          fire();
        }
      }, 50);
    });
  })();
</script>
</head>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KPR5LSH6" height="0" width="0"
      style="display:none;visibility:hidden"></iframe>
  </noscript>

  <div class="container">
    <header>
      <div class="topRow">
        <div class="badge">
          <span class="badgeDot" aria-hidden="true"></span>
          <span>Lead Demo</span>
          <span class="tiny">LinkedIn CAPI Tag + GTM Server-Side</span>
        </div>
        <div class="pill">
          Captured <code>li_fat_id</code>:
          <strong id="liFatIdDisplay" class="ok">(loading)</strong>
        </div>
      </div>

      <h1>LinkedIn CAPI Lead Form Demo via GTM Web + Server</h1>
      <p class="sub">
        Use this page to demo a clean <code>dataLayer</code> implementation for lead capture, how a <strong>GA4 client</strong>
        receives events and <code>user_data</code>, and how the <strong>LinkedIn CAPI Tag</strong> can consume it in GTM Server-Side.
      </p>
    </header>

    <div class="grid">
      <!-- LEFT: Form -->
      <section class="card" aria-labelledby="leadFormTitle">
        <div class="cardHeader">
          <h2 id="leadFormTitle">Lead Form</h2>
          <div class="actions" style="margin:0;">
            <button type="button" class="secondary" id="copySampleUrlBtn">Copy sample URL</button>
          </div>
        </div>

        <p class="note">
          On submit, this page pushes a <code>lead_submission</code> event to <code>dataLayer</code> with a
          <code>user_data</code> object. Use GTM Preview mode (Web + Server) to verify the payload.
        </p>

        <div class="divider"></div>

        <form id="leadForm" novalidate>
          <div class="row">
            <div class="field">
              <label for="first_name">First name</label>
              <input id="first_name" name="first_name" type="text" placeholder="Jane" autocomplete="given-name" required />
              <div class="error" id="err_first_name"></div>
            </div>

            <div class="field">
              <label for="last_name">Last name</label>
              <input id="last_name" name="last_name" type="text" placeholder="Doe" autocomplete="family-name" required />
              <div class="error" id="err_last_name"></div>
            </div>
          </div>

          <div class="field">
            <label for="email">Email address</label>
            <input id="email" name="email" type="email" placeholder="jane.doe@company.com" autocomplete="email" required />
            <div class="error" id="err_email"></div>
          </div>

          <div class="row">
            <div class="field">
              <label for="company_name">Company name</label>
              <input id="company_name" name="company_name" type="text" placeholder="Acme Inc." autocomplete="organization" required />
              <div class="error" id="err_company_name"></div>
            </div>

            <div class="field">
              <label for="job_title">Job title</label>
              <input id="job_title" name="job_title" type="text" placeholder="Marketing Manager" autocomplete="organization-title" required />
              <div class="error" id="err_job_title"></div>
            </div>
          </div>

          <div class="field">
            <label for="country">Country (ISO 2-letter code)</label>
            <select id="country" name="country" required>
              <option value="" selected disabled>Select a country</option>
              <option value="US">United States (US)</option>
              <option value="CA">Canada (CA)</option>
              <option value="GB">United Kingdom (GB)</option>
              <option value="AU">Australia (AU)</option>
              <option value="DE">Germany (DE)</option>
              <option value="FR">France (FR)</option>
              <option value="IN">India (IN)</option>
              <option value="JP">Japan (JP)</option>
              <option value="SG">Singapore (SG)</option>
              <option value="BR">Brazil (BR)</option>
            </select>
            <div class="error" id="err_country"></div>
            <div class="tiny">Tip: keep the dropdown short for MVP; expand later if needed.</div>
          </div>

          <div class="actions">
            <button type="submit" class="primary">Submit lead</button>
            <button type="button" class="secondary" id="resetBtn">Reset</button>
          </div>

          <div class="success" id="successBox" role="status" aria-live="polite">
            <strong class="ok">Success.</strong>
            <span class="muted">Pushed <code>lead_submission</code> to <code>dataLayer</code>. Check the Debug Panel and GTM Preview.</span>
          </div>
        </form>

        <p class="tiny" style="margin-top:12px;">
          Demo tip: open this page with <code>?li_fat_id=TEST123</code>, then submit the form.
          The value will be included as <code>user_data.user_id</code> on <code>page_view</code> and <code>lead_submission</code>.
        </p>
      </section>

      <!-- RIGHT: Debug + Notes -->
      <aside class="card debug" aria-labelledby="debugTitle">
        <div class="cardHeader" style="margin-bottom:6px;">
          <h2 id="debugTitle">Debug Panel</h2>
          <div class="actions" style="margin:0;">
            <button type="button" class="secondary" id="copyJsonBtn">Copy JSON</button>
            <button type="button" class="secondary" id="clearDebugBtn">Clear</button>
          </div>
        </div>

        <p class="note">
          Shows the <strong>latest</strong> object pushed to <code>dataLayer</code>. It updates automatically when
          <code>page_view</code> fires (after <code>gtm.load</code>) and when the form pushes <code>lead_submission</code>.
        </p>

        <div class="divider"></div>
        <pre id="debugPre">{}</pre>

        <div class="divider"></div>

        <h2 style="margin:0;">Demo Notes</h2>
        <ul>
          <li>Append <code>?li_fat_id=TEST123</code> to the URL (or use the button).</li>
          <li>Open GTM Preview mode (Web container + Server container).</li>
          <li>Confirm <code>page_view</code> fires after <code>gtm.load</code>, and <code>lead_submission</code> on submit.</li>
          <li>In Server-Side, verify the GA4 client receives <code>user_data</code>, then confirm the LinkedIn CAPI tag uses it.</li>
        </ul>

        <p class="tiny" style="margin:0;">
          This page stores <code>li_fat_id</code> in a cookie (90 days) when present in the URL, then reuses it on future visits.
        </p>
      </aside>
    </div>
  </div>

  <script>
    /**
     * =========================
     * Debug Panel Renderer (called by patched dataLayer.push)
     * =========================
     */
    (function initDebugPanel() {
      const debugPre = document.getElementById("debugPre");
      const copyJsonBtn = document.getElementById("copyJsonBtn");
      const clearDebugBtn = document.getElementById("clearDebugBtn");

      function getDataLayerSnapshot() {
        try {
          return Array.from(window.dataLayer || []);
        } catch (e) {
          return [];
        }
      }

      window.renderDebugPanel = function () {
        const snapshot = getDataLayerSnapshot();
        debugPre.textContent = JSON.stringify(snapshot, null, 2);
      };

      // Initial render
      window.renderDebugPanel();

      copyJsonBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(debugPre.textContent || "[]");
          copyJsonBtn.textContent = "Copied";
          setTimeout(() => (copyJsonBtn.textContent = "Copy JSON"), 900);
        } catch (e) {
          alert("Clipboard copy failed. You can manually select and copy the JSON.");
        }
      });

      clearDebugBtn.addEventListener("click", () => {
        debugPre.textContent = "[]"; // UI only; does NOT modify dataLayer history
      });
    })();
  </script>

  <script>
    /**
     * =========================
     * Copy sample URL button
     * =========================
     */
    (function initSampleUrlBtn() {
      const copySampleUrlBtn = document.getElementById("copySampleUrlBtn");

      copySampleUrlBtn.addEventListener("click", async () => {
        const base = window.location.origin + window.location.pathname;
        const sampleUrl = base + "?li_fat_id=TEST123";
        try {
          await navigator.clipboard.writeText(sampleUrl);
          copySampleUrlBtn.textContent = "Copied";
          setTimeout(() => (copySampleUrlBtn.textContent = "Copy sample URL"), 900);
        } catch (e) {
          alert("Clipboard copy failed. Here is the sample URL:\n\n" + sampleUrl);
        }
      });
    })();
  </script>

  <script>
    /**
     * =========================
     * Lead Form Submission
     * Validates input, then pushes lead_submission to dataLayer.
     * Payload uses Google Common Event schema style user_data.
     * =========================
     */
    (function initLeadForm() {
      const userId = window.__LI_FAT_ID__ || "";

      const form = document.getElementById("leadForm");
      const successBox = document.getElementById("successBox");
      const resetBtn = document.getElementById("resetBtn");

      const fields = {
        first_name: document.getElementById("first_name"),
        last_name: document.getElementById("last_name"),
        email: document.getElementById("email"),
        company_name: document.getElementById("company_name"),
        job_title: document.getElementById("job_title"),
        country: document.getElementById("country")
      };

      const errors = {
        first_name: document.getElementById("err_first_name"),
        last_name: document.getElementById("err_last_name"),
        email: document.getElementById("err_email"),
        company_name: document.getElementById("err_company_name"),
        job_title: document.getElementById("err_job_title"),
        country: document.getElementById("err_country")
      };

      function setError(name, msg) { errors[name].textContent = msg || ""; }
      function isBlank(v) { return !v || !String(v).trim(); }
      function isValidEmail(v) {
        const s = String(v || "").trim();
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
      }

      function validate() {
        let ok = true;

        const first = fields.first_name.value.trim();
        const last = fields.last_name.value.trim();
        const email = fields.email.value.trim();
        const company = fields.company_name.value.trim();
        const title = fields.job_title.value.trim();
        const country = fields.country.value;

        Object.keys(errors).forEach(k => setError(k, ""));

        if (isBlank(first)) { setError("first_name", "Please enter a first name."); ok = false; }
        if (isBlank(last)) { setError("last_name", "Please enter a last name."); ok = false; }

        if (isBlank(email)) {
          setError("email", "Please enter an email address.");
          ok = false;
        } else if (!isValidEmail(email)) {
          setError("email", "Please enter a valid email address.");
          ok = false;
        }

        if (isBlank(company)) { setError("company_name", "Please enter a company name."); ok = false; }
        if (isBlank(title)) { setError("job_title", "Please enter a job title."); ok = false; }
        if (isBlank(country)) { setError("country", "Please select a country."); ok = false; }

        return ok;
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        successBox.style.display = "none";

        if (!validate()) return;

        const payload = {
          event: "lead_submission",
          user_data: {
            email: fields.email.value.trim(),
            user_id: userId,
            address: {
              first_name: fields.first_name.value.trim(),
              last_name: fields.last_name.value.trim(),
              country: fields.country.value
            },
            company_name: fields.company_name.value.trim(),
            job_title: fields.job_title.value.trim()
          }
        };

        window.dataLayer.push(payload);

        successBox.style.display = "block";
        console.log("dataLayer push:", payload);
      });

      resetBtn.addEventListener("click", () => {
        form.reset();
        successBox.style.display = "none";
        Object.keys(errors).forEach(k => setError(k, ""));
      });
    })();
  </script>
</body>

</html>
